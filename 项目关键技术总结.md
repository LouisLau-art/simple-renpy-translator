# projz_renpy_translation 项目关键技术总结

基于对原项目的深入分析，整理出以下关键技术细节，供AI开发人员参考：

## 1. 项目架构与核心设计

### 1.1 TranslationIndex系统
- **核心类**: `TranslationIndex` (store/index.py)
- **作用**: 项目的中央管理系统，负责管理翻译索引、统计数据、数据库操作
- **关键功能**:
  - `from_dir()`: 从RenPy项目目录创建索引
  - `import_translations()`: 导入翻译数据
  - `export_translations()`: 生成翻译文件
  - `update_translations()`: 批量更新翻译

### 1.2 Project系统
- **核心类**: `Project` (injection模块)
- **作用**: 代表RenPy项目的抽象，包含项目路径、游戏信息、注入状态等

## 2. RenPy文件解析机制

### 2.1 解析流程
1. **文件扫描**: 递归扫描`game`目录下的`.rpy`文件
2. **内容解析**: 使用AST解析RenPy语法结构
3. **文本提取**: 提取可翻译的文本（dialogue、string等）
4. **标识符生成**: 为每个文本块生成唯一TID

### 2.2 文本标识符系统
```python
# TID格式: [类型][块索引]_[文档ID]
DIALOGUE_ID_PREFIX = 'D'    # 对话
STRING_ID_PREFIX = 'S'      # 字符串
TID_PATTERN = r'^([DS])(\d+)_(\d+)$'
```

## 3. 翻译工作流程

### 3.1 基本翻译流程
1. **导入阶段**: `TranslationIndex.import_translations()`
2. **翻译阶段**: LLM或其他翻译器处理
3. **更新阶段**: `TranslationIndex.update_translations()`
4. **导出阶段**: `TranslationIndex.export_translations()`

### 3.2 导入/导出机制
- **导入**: 读取`game/tl/{lang}`目录下的rpy文件
- **导出**: 生成翻译后的rpy文件到目标目录

## 4. 数据库设计

### 4.1 数据库结构
- **存储位置**: `{projz_}_{nickname_}_{tag}.db`
- **表结构**: 按语言分表（D_en, S_en等）
- **数据格式**: JSON字段存储复杂的文本块信息

### 4.2 关键表结构
```sql
-- 对话表
CREATE TABLE D_{lang} (
    doc_id INTEGER PRIMARY KEY,
    identifier TEXT,
    filename TEXT, 
    linenumber INTEGER,
    block TEXT  -- JSON格式的文本块
);

-- 字符串表  
CREATE TABLE S_{lang} (
    doc_id INTEGER PRIMARY KEY,
    identifier TEXT,
    filename TEXT,
    linenumber INTEGER, 
    block TEXT   -- JSON格式的文本块
);
```

## 5. RenPy注入系统

### 5.1 注入类型
- **基础注入** (`BASE_INJECTION`): 允许翻译操作
- **i18n注入** (`I18N_INJECTION`): 语言切换菜单

### 5.2 注入原理
- 修改RenPy源代码
- 插入翻译钩子
- 生成新的rpyc文件

## 6. 翻译器系统

### 6.1 LLM翻译器
- **类**: `_InnerTranslator` (command/translation/llm.py)
- **基础**: OpenAI翻译器
- **特点**: 支持对话历史、维护翻译一致性

### 6.2 翻译器接口
```python
def register_cmd_translator(name: str, translator):
    """注册翻译器"""
    _TRANSLATOR[name] = translator
```

## 7. 关键依赖与工具

### 7.1 核心依赖
- `regex`: 高级正则表达式处理
- `tqdm`: 进度条显示
- `prettytable`: 表格格式化输出

### 7.2 文件处理工具
- **转换器系统**: `FileTranslationIndex` 
- **支持格式**: HTML, Excel, JSON等
- **用途**: 导入外部翻译文件

## 8. 命令行接口设计

### 8.1 核心命令
- `new`: 创建新的TranslationIndex
- `import`: 导入翻译数据
- `export`: 导出翻译数据
- `translate`: 使用指定翻译器翻译
- `launch`: 启动RenPy游戏
- `inject`: 执行代码注入

### 8.2 参数设计
- `--say-only`: 仅处理对话语句
- `--force`: 强制覆盖现有文件
- `--limit`: 限制处理的文本数量

## 9. 关键技术挑战

### 9.1 复杂依赖管理
- 125个依赖包，约500MB大小
- 版本兼容性问题（Python 3.8-3.11）
- RenPy注入系统与Python 3.13不兼容

### 9.2 架构复杂性
- 30+个命令类
- 多层继承体系
- 复杂的注入系统

## 10. 新项目设计建议

### 10.1 架构简化
- 去除注入系统，直接文件操作
- 简化命令体系（6个核心命令）
- 最小化依赖（10个左右）

### 10.2 Python 3.13兼容性
- 避免使用已废弃的语法特性
- 选择兼容的第三方库版本
- 简化字符串处理逻辑

### 10.3 核心功能保留
- RenPy文件解析
- 翻译索引管理  
- 批量翻译处理
- 文件导入/导出

这些技术细节为开发新的RenPy翻译工具提供了完整的参考基础。